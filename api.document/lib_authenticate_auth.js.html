<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/authenticate/auth.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/authenticate/auth.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Created by deepak on 5/11/2017.
 */
var jwt = require('jwt-simple');
var dateUtil = require('date-format-utils');
var auth = {};
/**
 * Authenticate request token
 * @param request
 * @param response
 * @param next
 */
function authenticate(request, response, next) {
    if (request.method == 'OPTIONS') {
        _logger.debug("Auth options");
        response.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE');
        response.setHeader("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept, Authorization");
        response.setHeader("access-control-expose-headers", "Origin, X-Requested-With, Content-Type, Accept, Authorization");
        next();
    }
    else {
        _logger.debug("Auth Started");
        //Write your authentication logic here
        try {
            var token = request.headers['authorization'] || null;
            if (token) {
                var decoded = jwt.decode(token, _config.authConfig.secretKey);
                _logger.debug("decoded msg::", JSON.stringify(decoded));
                if (decoded.expire_at &lt;= Date.now()) {
                    _logger.debug("Token Force Expire done, expire_at:",dateUtil.formatDate(decoded.expire_at,'hh:mm:ss tt'));
                    _utils.send(response, {
                        type: _constants.RESPONSE_MESSAGES.TOKEN_EXPIRED
                    });
                } else {
                    var inactiveTime = 0;
                    if (decoded.last_modified &lt; Date.now()) {
                        inactiveTime = Math.abs((Date.now() - decoded.last_modified) / 60000);
                    }
                    if (inactiveTime >= _config.authConfig.inactiveTimeFrame) {
                        _logger.debug("Token Expire due to inactive");
                        _utils.send(response, {
                            type: _constants.RESPONSE_MESSAGES.TOKEN_EXPIRED
                        });
                    }
                    else {
                        _logger.debug("Token authorized");
                        request.decoded = decoded;
                        var newToken = generateToken(decoded.payload, decoded.expire_at);
                        response.setHeader('Authorization', newToken);
                        next();
                    }
                }
            }
            else {
                _utils.send(response, {
                    type: _constants.RESPONSE_MESSAGES.NOT_AUTHORIZED
                });
            }

        } catch (e) {
            _logger.error("Error generating auth token, ",e);
            _utils.send(response, {
                type: _constants.RESPONSE_MESSAGES.NOT_AUTHORIZED
            });
        }

        _logger.debug("Auth Finish");
    }
};
auth.authenticate = authenticate;

/**
 * Generate authentication token
 * @param payload
 * @param expire_at
 * @returns {*}
 */
function generateToken(payload, expire_at) {
    var last_modified = Date.now();
    if (_utils.isEmpty(expire_at)) {
        var time = 60 * 60;
        if (_config.authConfig.forceExpireTimeFrame &amp;&amp; typeof _config.authConfig.forceExpireTimeFrame == "number")
            time = _config.authConfig.forceExpireTimeFrame * 60;
        else
            _logger.debug("Default 60min force expire time frame set.");
        expire_at = _utils.expiresAt(time);
    }
    var token = jwt.encode({
        last_modified: last_modified,
        expire_at: expire_at,
        payload: payload
    }, _config.authConfig.secretKey);

    return token;
}
auth.generateToken = generateToken;


module.exports = auth;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#authenticate">authenticate</a></li><li><a href="global.html#checkRequiredMissingParam">checkRequiredMissingParam</a></li><li><a href="global.html#constants">constants</a></li><li><a href="global.html#dbInsertData">dbInsertData</a></li><li><a href="global.html#filePath">filePath</a></li><li><a href="global.html#findMissingKeyInObject">findMissingKeyInObject</a></li><li><a href="global.html#generateToken">generateToken</a></li><li><a href="global.html#getSampleRequest">getSampleRequest</a></li><li><a href="global.html#isArray">isArray</a></li><li><a href="global.html#isEmpty">isEmpty</a></li><li><a href="global.html#jwt">jwt</a></li><li><a href="global.html#mongoClient">mongoClient</a></li><li><a href="global.html#mysql">mysql</a></li><li><a href="global.html#nodemailer">nodemailer</a></li><li><a href="global.html#postSampleRequest">postSampleRequest</a></li><li><a href="global.html#redis">redis</a></li><li><a href="global.html#send">send</a></li><li><a href="global.html#utils">utils</a></li><li><a href="global.html#validateResponseCode">validateResponseCode</a></li><li><a href="global.html#winston">winston</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Thu May 25 2017 11:47:46 GMT+0530 (India Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
